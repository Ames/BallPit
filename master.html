<html>
<style>
#box{
	position:absolute;
	top:0px;
	left:0px;
	padding:20px;	
}
#canvas{
	/*background-color:#EBEBEB;*/
}
</style>
<head>

<script type='text/javascript'>

var socketPort=8124;

var socketHost='login.sccs.swarthmore.edu';

//var socketPath=window.location.protocol+"//"+window.location.hostname+":"+socketPort+'/';

var socketPath='http://login.sccs.swarthmore.edu:8124/';

var scr=document.createElement('script');
scr.src=socketPath+'socket.io/socket.io.js';

WEB_SOCKET_SWF_LOCATION=socketPath+'socket.io/lib/vendor/web-socket-js/WebSocketMain.swf'

if(!document.head)document.head=document.getElementsByTagName('head')[0];

document.head.appendChild(scr);

var msgDiv;
var headDiv;
var socket;
var textInput;

var master;

var canvas;

function init(){
	
	canvas=document.getElementById('canvas');
	
	headDiv=document.getElementById('header');
	msgDiv=document.getElementById('messages');
	
	textInput=document.getElementById('textInput');
	textInput.disabled=true;

	
	//force opera to use flashsocket
	if(io.util.opera){
		socket = new io.Socket(socketHost,{'port':socketPort,'transports':["flashsocket"]});
	}else{
		socket = new io.Socket(socketHost,{'port':socketPort});
	}
	
	socket.connect();

	socket.on('connect',handleConnect);
	socket.on('message',handleMessage);
	socket.on('disconnect',handleDisconnect);
	
	socket.sendJSON=function(data){
		this.send(JSON.stringify(data));
	}
	
	setInterval('keepAlive()',2000); //2 seconds
}

function keepAlive(){
	if(!socket.connected){
		socket.connect();	
	}
}

function handleConnect(){
//	headDiv.innerHTML="connected";
	socket.sendJSON({'declare':'master'});
	textInput.disabled=false;
}

function handleDisconnect(){
//	headDiv.innerHTML="";
	textInput.disabled=true;
	msgDiv.innerHTML="";
}

function handleMessage(msg){
	
	var data=JSON.parse(msg);
	
	if(data.message){
		msgDiv.innerHTML+=data.message+'<br>';
	}
	
	if(data.spaces){
		
		//canvas or raphael, that is the question...
		
		//we should draw elsewhere, and perhaps update only when necessary
		
//		canvas.width=document.width-20;
//		canvas.height=document.height-20;
//		var ctx = canvas.getContext('2d');
//		
//		ctx.fillStyle = "rgb(200,0,0)";
//		ctx.strokeStyle = "rgb(,0,0)";
//		ctx.lineWidth = "4";
//		
//		ctx.strokeRect(30, 40, 100, 120);
//		//ctx.fillRect(30, 40, 100, 120);

		
		msgDiv.innerHTML='<ul>';
		for(var i in data.spaces){
			msgDiv.innerHTML+='<li>'+data.spaces[i].id+': '+data.spaces[i].width
			  +' x '+data.spaces[i].height+' ('+data.spaces[i].address+')</li>';
		}
		msgDiv.innerHTML+='</ul>';
	}
	
	if(data.links){
		
		msgDiv.innerHTML+='<ul>';
		for(var i in data.links){
			msgDiv.innerHTML+='<li>'+data.links[i][0][0]+'.'+data.links[i][0][1]+
			       ' -- '+data.links[i][1][0]+'.'+data.links[i][1][1]+'</li>';
		}
		msgDiv.innerHTML+='</ul>';
	}

}

function sendMessage(){
	var str=textInput.value;
	
	switch(str[0]){
		case '#': //link
			//[[id,edge],[id,edge]]
			//[[1,3],[2,1]]
			data=JSON.parse(str.substring(1));
			socket.sendJSON({'link':data});
			
			break;
		case '%': //unlink
			socket.sendJSON({'unlink':str.substring(1)});
			break;
//		case '@': //gravity
//			
//			socket.sendJSON({'unlink':str.substring(1)});
//			break;
		case '\\':
			var data={'global':{}};
			data.global[str.substring(1)]=1;
			socket.sendJSON(data);
			break;
		default:
			socket.sendJSON({'message':str});
			break;
	}
	
	textInput.value="";
}

</script>

</head>
<body onload='init()'>

<canvas id='canvas'></canvas>

<div id='box'>
	
	<div id='header'></div>
	
	<form action='javascript://0' onSubmit="sendMessage();return false;"><input id='textInput' onEnter='alert()' type="text"></input></form>
	
	<div id='messages'></div>

</div>

</body>

</html>
